#!/bin/bash

# Usage:
# source run_experiment <benchmark> <lang> <exp_type> <size> [<parallel_invocations>] 
#

OUTPUT_DIR=cloudflare-results/$1/$2/$3/reps_$4
FIG_DIR=cloudflare-results/fig/$1/
CONFIG_NAME=config/generated/cloudflare-config.json
PYTHON_VERSION="3.11"
NODEJS_VERSION="18"

if [[ $2 == "python" ]]; then
  LANG_VERSION="3.11"
else 
  LANG_VERSION="18"
fi

mkdir -p config/generated

tee $CONFIG_NAME << EndOfText
{
  "experiments": {
    "type": "perf-cost",
    "deployment": "cloudflare",
    "update_code": false,
    "update_storage": false,
    "download_results": false,
    "architecture": "x64",
    "container_deployment": false,
    "runtime": {
      "language": "$2",
      "version": "$LANG_VERSION"
    },
    "perf-cost" : {
      "benchmark": "$1",
      "experiments": ["$3"],
      "input-size": "test",
      "repetitions": $4,
      "concurrent-invocations": ${5:-10},
      "memory-sizes": [128]
    }
  },
  "deployment": {
    "name": "cloudflare",
    "cloudflare": {},
    "container": false
  }
}
EndOfText


mkdir -p $OUTPUT_DIR 

source .env 
./sebs.py experiment invoke perf-cost --config $CONFIG_NAME --output-dir $OUTPUT_DIR 

mkdir -p $FIG_DIR

python3 useful_results.py $OUTPUT_DIR/perf-cost/$3_results_128.json
